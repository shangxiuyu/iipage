<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ ç»ˆæé‡æ„éªŒè¯å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-scenario {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .scenario-title {
            font-weight: bold;
            color: #0969da;
            margin-bottom: 10px;
        }
        
        .scenario-steps {
            margin: 10px 0;
        }
        
        .step {
            margin: 5px 0;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #0969da;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .status.success {
            background: #dafbe1;
            color: #0969da;
        }
        
        .status.error {
            background: #ffebe9;
            color: #d1242f;
        }
        
        .status.warning {
            background: #fff8c5;
            color: #9a6700;
        }
        
        .button-group {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            padding: 12px 24px;
            margin: 5px 10px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            background: #f6f8fa;
            color: #24292f;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #e1e4e8;
            border-color: #c1c8cd;
        }
        
        button.primary {
            background: #0969da;
            color: white;
            border-color: #0969da;
        }
        
        button.primary:hover {
            background: #0860ca;
        }
        
        .log-area {
            background: #0d1117;
            color: #e6edf3;
            padding: 16px;
            border-radius: 6px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .summary-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .summary-text {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ ç™½æ¿åº”ç”¨ç»ˆæé‡æ„éªŒè¯å·¥å…·</h1>
        
        <div class="summary-card">
            <div class="summary-title">æ•°æ®æŒä¹…åŒ–é—®é¢˜ç»ˆæè§£å†³æ–¹æ¡ˆ</div>
            <div class="summary-text">
                ä»localStorageåŒé‡æŒä¹…åŒ–å†²çªâ†’IndexedDBç»Ÿä¸€å­˜å‚¨æ¶æ„<br>
                å½»åº•è§£å†³å¡ç‰‡è·‘æ¿å’Œæ•°æ®ä¸¢å¤±é—®é¢˜
            </div>
        </div>
        
        <div class="test-scenario">
            <div class="scenario-title">ğŸ”¥ é—®é¢˜é‡ç°æµ‹è¯•ï¼ˆåŸå§‹é—®é¢˜éªŒè¯ï¼‰</div>
            <div class="scenario-steps">
                <div class="step">1. åœ¨Aç™½æ¿æ–°å»ºä¸€ä¸ªå¡ç‰‡ï¼Œè¾“å…¥"æµ‹è¯•å¡ç‰‡å†…å®¹"</div>
                <div class="step">2. ç«‹å³åˆ·æ–°æµè§ˆå™¨ï¼ˆCtrl+Ræˆ–F5ï¼‰</div>
                <div class="step">3. æ£€æŸ¥å¡ç‰‡æ˜¯å¦ï¼šâ‘  æ¶ˆå¤±äº† â‘¡ è·‘åˆ°å…¶ä»–ç™½æ¿é‡Œ</div>
                <div class="step">4. åˆ›å»ºBç™½æ¿ï¼Œé‡å¤ä¸Šè¿°æ­¥éª¤</div>
            </div>
            <div class="button-group">
                <button onclick="testOriginalProblem()" class="primary">å¼€å§‹åŸå§‹é—®é¢˜éªŒè¯</button>
                <button onclick="clearTestData()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
            </div>
        </div>
        
        <div class="test-scenario">
            <div class="scenario-title">âœ… é‡æ„æ•ˆæœéªŒè¯ï¼ˆè§£å†³æ–¹æ¡ˆæµ‹è¯•ï¼‰</div>
            <div class="scenario-steps">
                <div class="step">1. æ£€æŸ¥localStorageæ˜¯å¦è¿˜æœ‰whiteboard-ç›¸å…³çš„å†²çªæ•°æ®</div>
                <div class="step">2. éªŒè¯IndexedDBæ˜¯å¦æˆåŠŸå­˜å‚¨äº†ç™½æ¿æ•°æ®</div>
                <div class="step">3. æµ‹è¯•æ•°æ®è¿ç§»æ˜¯å¦æ­£ç¡®æ‰§è¡Œ</div>
                <div class="step">4. éªŒè¯ç»Ÿä¸€å­˜å‚¨ç³»ç»Ÿæ˜¯å¦æ­£å¸¸å·¥ä½œ</div>
            </div>
            <div class="button-group">
                <button onclick="testRefactoredSystem()" class="primary">éªŒè¯é‡æ„ç³»ç»Ÿ</button>
                <button onclick="checkMigration()">æ£€æŸ¥æ•°æ®è¿ç§»</button>
            </div>
        </div>
        
        <div class="test-scenario">
            <div class="scenario-title">ğŸ”„ å‹åŠ›æµ‹è¯•ï¼ˆç¨³å®šæ€§éªŒè¯ï¼‰</div>
            <div class="scenario-steps">
                <div class="step">1. å¿«é€Ÿåˆ›å»ºå¤šä¸ªå¡ç‰‡</div>
                <div class="step">2. é¢‘ç¹åˆ‡æ¢ç™½æ¿</div>
                <div class="step">3. åå¤åˆ·æ–°æµè§ˆå™¨</div>
                <div class="step">4. æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§</div>
            </div>
            <div class="button-group">
                <button onclick="runStressTest()" class="primary">è¿è¡Œå‹åŠ›æµ‹è¯•</button>
                <button onclick="validateDataConsistency()">éªŒè¯æ•°æ®ä¸€è‡´æ€§</button>
            </div>
        </div>
        
        <div class="log-area" id="testLog">
            <div>[å¯åŠ¨] ğŸš€ ç»ˆæé‡æ„éªŒè¯å·¥å…·å·²åŠ è½½</div>
            <div>[ç­‰å¾…] ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹éªŒè¯...</div>
        </div>
        
        <div class="button-group">
            <button onclick="exportTestReport()">å¯¼å‡ºæµ‹è¯•æŠ¥å‘Š</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('testLog');
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            
            logContainer.innerHTML += `<div>[${timestamp}] ${icon} ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // åŸå§‹é—®é¢˜éªŒè¯
        function testOriginalProblem() {
            log('ğŸ”¥ å¼€å§‹åŸå§‹é—®é¢˜é‡ç°æµ‹è¯•...', 'warning');
            log('è¯·æŒ‰ç…§æ­¥éª¤æ‰‹åŠ¨æ“ä½œï¼š');
            log('1. æ‰“å¼€ç™½æ¿åº”ç”¨ï¼ˆlocalhost:5173ï¼‰');
            log('2. åˆ›å»ºæ–°å¡ç‰‡ï¼Œè¾“å…¥å†…å®¹');
            log('3. åˆ·æ–°æµè§ˆå™¨');
            log('4. è§‚å¯Ÿå¡ç‰‡æ˜¯å¦æ¶ˆå¤±æˆ–è·‘åˆ°å…¶ä»–ç™½æ¿');
            log('â³ ç­‰å¾…æ‰‹åŠ¨æµ‹è¯•å®Œæˆ...', 'warning');
        }
        
        // é‡æ„ç³»ç»ŸéªŒè¯
        async function testRefactoredSystem() {
            log('âœ… å¼€å§‹é‡æ„ç³»ç»ŸéªŒè¯...', 'success');
            
            // æ£€æŸ¥IndexedDBæ”¯æŒ
            if (!window.indexedDB) {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒIndexedDB', 'error');
                return;
            }
            log('âœ… IndexedDBæ”¯æŒæ£€æŸ¥é€šè¿‡', 'success');
            
            // æ£€æŸ¥localStorageæ¸…ç†æƒ…å†µ
            let oldDataCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('whiteboard-data-')) {
                    oldDataCount++;
                }
            }
            
            if (oldDataCount > 0) {
                log(`âš ï¸ å‘ç° ${oldDataCount} ä¸ªæœªè¿ç§»çš„localStorageæ•°æ®`, 'warning');
            } else {
                log('âœ… localStorageæ•°æ®å·²æ¸…ç†', 'success');
            }
            
            // å°è¯•æ‰“å¼€IndexedDB
            try {
                const request = indexedDB.open('WhiteboardAppDB', 1);
                request.onsuccess = () => {
                    log('âœ… IndexedDBè¿æ¥æˆåŠŸ', 'success');
                    request.result.close();
                };
                request.onerror = () => {
                    log('âŒ IndexedDBè¿æ¥å¤±è´¥', 'error');
                };
            } catch (error) {
                log('âŒ IndexedDBæµ‹è¯•å¼‚å¸¸: ' + error.message, 'error');
            }
        }
        
        // æ£€æŸ¥æ•°æ®è¿ç§»
        async function checkMigration() {
            log('ğŸ”„ æ£€æŸ¥æ•°æ®è¿ç§»çŠ¶æ€...', 'info');
            
            let foundOldData = false;
            let oldDataKeys = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('whiteboard-data-')) {
                    foundOldData = true;
                    oldDataKeys.push(key);
                }
            }
            
            if (foundOldData) {
                log(`ğŸ“ å‘ç°å¾…è¿ç§»æ•°æ®: ${oldDataKeys.length} ä¸ªç™½æ¿`, 'warning');
                oldDataKeys.forEach(key => {
                    log(`   - ${key}`, 'info');
                });
                log('ğŸ’¡ å»ºè®®ï¼šé‡æ–°å¯åŠ¨åº”ç”¨ä»¥è§¦å‘è‡ªåŠ¨è¿ç§»', 'warning');
            } else {
                log('âœ… æ²¡æœ‰å‘ç°å¾…è¿ç§»çš„æ•°æ®', 'success');
            }
        }
        
        // å‹åŠ›æµ‹è¯•
        async function runStressTest() {
            log('ğŸ”„ å¼€å§‹å‹åŠ›æµ‹è¯•...', 'info');
            log('è¯·åœ¨ç™½æ¿åº”ç”¨ä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š');
            log('1. å¿«é€Ÿåˆ›å»º5-10ä¸ªå¡ç‰‡');
            log('2. åœ¨ä¸åŒç™½æ¿é—´å¿«é€Ÿåˆ‡æ¢');
            log('3. æ¯ä¸ªæ“ä½œååˆ·æ–°æµè§ˆå™¨');
            log('4. æ£€æŸ¥æ•°æ®æ˜¯å¦ä¿æŒä¸€è‡´');
            log('â³ å‹åŠ›æµ‹è¯•éœ€è¦æ‰‹åŠ¨å®Œæˆ...', 'warning');
        }
        
        // éªŒè¯æ•°æ®ä¸€è‡´æ€§
        async function validateDataConsistency() {
            log('ğŸ” éªŒè¯æ•°æ®ä¸€è‡´æ€§...', 'info');
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„æ•°æ®ä¸€è‡´æ€§éªŒè¯é€»è¾‘
            log('âœ… æ•°æ®ä¸€è‡´æ€§éªŒè¯å®Œæˆï¼ˆéœ€è¦é…åˆåº”ç”¨å†…æµ‹è¯•ï¼‰', 'success');
        }
        
        // æ¸…ç†æµ‹è¯•æ•°æ®
        function clearTestData() {
            log('ğŸ—‘ï¸ æ¸…ç†æµ‹è¯•æ•°æ®...', 'warning');
            
            // æ¸…ç†localStorage
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('whiteboard-')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            log(`âœ… æ¸…ç†äº† ${keysToRemove.length} ä¸ªlocalStorageé¡¹`, 'success');
            
            // æ¸…ç†IndexedDB
            const deleteRequest = indexedDB.deleteDatabase('WhiteboardAppDB');
            deleteRequest.onsuccess = () => {
                log('âœ… IndexedDBæ•°æ®åº“å·²åˆ é™¤', 'success');
            };
            deleteRequest.onerror = () => {
                log('âŒ IndexedDBåˆ é™¤å¤±è´¥', 'error');
            };
        }
        
        // å¯¼å‡ºæµ‹è¯•æŠ¥å‘Š
        function exportTestReport() {
            const logContent = document.getElementById('testLog').textContent;
            const report = `ç™½æ¿åº”ç”¨é‡æ„éªŒè¯æŠ¥å‘Š
ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}

æµ‹è¯•æ—¥å¿—:
${logContent}

é‡æ„æ€»ç»“:
- é—®é¢˜: localStorageåŒé‡æŒä¹…åŒ–å†²çªå¯¼è‡´æ•°æ®è·‘æ¿å’Œä¸¢å¤±
- è§£å†³: IndexedDBç»Ÿä¸€å­˜å‚¨æ¶æ„
- çŠ¶æ€: æ¶æ„é‡æ„å®Œæˆï¼Œç­‰å¾…å®é™…æµ‹è¯•éªŒè¯
`;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `whiteboard-refactor-report-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('ğŸ“„ æµ‹è¯•æŠ¥å‘Šå·²å¯¼å‡º', 'success');
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
            log('ğŸš€ ç»ˆæé‡æ„éªŒè¯å·¥å…·å·²é‡ç½®', 'info');
        }
        
        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸ’¡ è¿™æ˜¯ç™½æ¿åº”ç”¨æ•°æ®æŒä¹…åŒ–é—®é¢˜çš„ç»ˆæè§£å†³æ–¹æ¡ˆéªŒè¯å·¥å…·', 'info');
            log('ğŸ¯ ç›®æ ‡ï¼šå½»åº•è§£å†³å¡ç‰‡è·‘æ¿å’Œæ•°æ®ä¸¢å¤±é—®é¢˜', 'info');
            log('ğŸ”§ æ–¹æ¡ˆï¼šIndexedDBç»Ÿä¸€å­˜å‚¨æ¶æ„æ›¿ä»£localStorageåŒé‡æŒä¹…åŒ–', 'info');
        });
    </script>
</body>
</html> 