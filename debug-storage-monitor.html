<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™½æ¿å­˜å‚¨å®æ—¶ç›‘æ§å™¨</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .container {
            background: #2d2d2d;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        h1 {
            color: #00ff88;
            border-bottom: 2px solid #00ff88;
            padding-bottom: 10px;
        }
        .monitor-section {
            margin: 20px 0;
            padding: 16px;
            background: #3a3a3a;
            border-radius: 8px;
            border-left: 4px solid #00ff88;
        }
        .log-container {
            height: 300px;
            overflow-y: auto;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 4px 0;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .log-entry.read {
            background: #001a33;
            color: #66ccff;
        }
        .log-entry.write {
            background: #1a3300;
            color: #88ff66;
        }
        .log-entry.delete {
            background: #330000;
            color: #ff6666;
        }
        .log-entry.conflict {
            background: #331100;
            color: #ffaa00;
            font-weight: bold;
        }
        .controls {
            display: flex;
            gap: 12px;
            margin: 16px 0;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #007AFF;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #ff3b30;
        }
        button.danger:hover {
            background: #d70015;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.active {
            background: #00ff88;
            box-shadow: 0 0 6px #00ff88;
        }
        .status-indicator.inactive {
            background: #666;
        }
        .data-preview {
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 12px;
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .storage-key {
            color: #ffaa00;
            font-weight: bold;
        }
        .timestamp {
            color: #888;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç™½æ¿å­˜å‚¨å®æ—¶ç›‘æ§å™¨</h1>
        
        <div class="monitor-section">
            <h3>
                <span class="status-indicator" id="monitorStatus"></span>
                ç›‘æ§çŠ¶æ€
            </h3>
            <div class="controls">
                <button onclick="startMonitoring()">å¼€å§‹ç›‘æ§</button>
                <button onclick="stopMonitoring()">åœæ­¢ç›‘æ§</button>
                <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                <button onclick="checkConflicts()" class="danger">æ£€æŸ¥å†²çª</button>
                <button onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
            </div>
        </div>

        <div class="monitor-section">
            <h3>ğŸ“‹ å®æ—¶æ“ä½œæ—¥å¿—</h3>
            <div class="log-container" id="logContainer">
                <div class="log-entry">ç­‰å¾…ç›‘æ§å¼€å§‹...</div>
            </div>
        </div>

        <div class="monitor-section">
            <h3>ğŸ’¾ å½“å‰å­˜å‚¨çŠ¶æ€</h3>
            <button onclick="refreshStorageState()">åˆ·æ–°å­˜å‚¨çŠ¶æ€</button>
            <div class="data-preview" id="storageState">
                ç‚¹å‡»"åˆ·æ–°å­˜å‚¨çŠ¶æ€"æŸ¥çœ‹å½“å‰æ‰€æœ‰ç™½æ¿æ•°æ®...
            </div>
        </div>

        <div class="monitor-section">
            <h3>âš ï¸ å†²çªæ£€æµ‹ç»“æœ</h3>
            <div class="data-preview" id="conflictResults">
                ç‚¹å‡»"æ£€æŸ¥å†²çª"å¼€å§‹æ£€æµ‹...
            </div>
        </div>
    </div>

    <script>
        let isMonitoring = false;
        let originalSetItem = localStorage.setItem;
        let originalGetItem = localStorage.getItem;
        let originalRemoveItem = localStorage.removeItem;
        let logEntries = [];

        // æ›´æ–°ç›‘æ§çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateMonitorStatus() {
            const indicator = document.getElementById('monitorStatus');
            if (isMonitoring) {
                indicator.className = 'status-indicator active';
            } else {
                indicator.className = 'status-indicator inactive';
            }
        }

        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addLogEntry(type, key, value = null, extra = '') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {
                timestamp,
                type,
                key,
                value,
                extra
            };
            logEntries.push(entry);

            const logContainer = document.getElementById('logContainer');
            const logElement = document.createElement('div');
            logElement.className = `log-entry ${type}`;
            
            let logText = `[${timestamp}] ${type.toUpperCase()}: ${key}`;
            if (extra) logText += ` ${extra}`;
            if (value && type === 'write') {
                try {
                    const data = JSON.parse(value);
                    const nodeCount = data.nodes ? data.nodes.length : 0;
                    logText += ` (${nodeCount} nodes)`;
                } catch {}
            }
            
            logElement.textContent = logText;
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;

            // æ£€æµ‹å†²çª
            if (key.startsWith('whiteboard-')) {
                detectRealTimeConflict(key, type);
            }
        }

        // å®æ—¶å†²çªæ£€æµ‹
        function detectRealTimeConflict(key, type) {
            if (type === 'write') {
                // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªå†™å…¥æ“ä½œåœ¨çŸ­æ—¶é—´å†…å‘ç”Ÿ
                const recentWrites = logEntries.filter(entry => 
                    entry.key === key && 
                    entry.type === 'write' && 
                    Date.now() - new Date(entry.timestamp).getTime() < 1000
                );
                
                if (recentWrites.length > 1) {
                    addLogEntry('conflict', key, null, 'æ£€æµ‹åˆ°å¿«é€Ÿé‡å¤å†™å…¥!');
                }
            }
        }

        // å¼€å§‹ç›‘æ§
        function startMonitoring() {
            if (isMonitoring) return;
            
            isMonitoring = true;
            updateMonitorStatus();
            
            // æ‹¦æˆªlocalStorageæ“ä½œ
            localStorage.setItem = function(key, value) {
                addLogEntry('write', key, value);
                return originalSetItem.call(this, key, value);
            };
            
            localStorage.getItem = function(key) {
                const value = originalGetItem.call(this, key);
                if (key.startsWith('whiteboard-')) {
                    addLogEntry('read', key, value);
                }
                return value;
            };
            
            localStorage.removeItem = function(key) {
                addLogEntry('delete', key);
                return originalRemoveItem.call(this, key);
            };
            
            addLogEntry('write', 'SYSTEM', null, 'ç›‘æ§å·²å¼€å§‹');
        }

        // åœæ­¢ç›‘æ§
        function stopMonitoring() {
            if (!isMonitoring) return;
            
            isMonitoring = false;
            updateMonitorStatus();
            
            // æ¢å¤åŸå§‹å‡½æ•°
            localStorage.setItem = originalSetItem;
            localStorage.getItem = originalGetItem;
            localStorage.removeItem = originalRemoveItem;
            
            addLogEntry('write', 'SYSTEM', null, 'ç›‘æ§å·²åœæ­¢');
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            logEntries = [];
            document.getElementById('logContainer').innerHTML = '<div class="log-entry">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // åˆ·æ–°å­˜å‚¨çŠ¶æ€
        function refreshStorageState() {
            const storageState = document.getElementById('storageState');
            let html = '';
            
            const allKeys = Object.keys(localStorage).filter(key => key.startsWith('whiteboard-'));
            
            if (allKeys.length === 0) {
                html = 'æ²¡æœ‰æ‰¾åˆ°ç™½æ¿ç›¸å…³æ•°æ®';
            } else {
                allKeys.forEach(key => {
                    try {
                        const value = localStorage.getItem(key);
                        const data = JSON.parse(value);
                        const nodeCount = data.nodes ? data.nodes.length : 0;
                        const title = data.title || 'æœªå‘½å';
                        const lastSaved = data.lastSavedAt || 'æœªçŸ¥';
                        
                        html += `<div>
                            <span class="storage-key">${key}</span><br>
                            æ ‡é¢˜: ${title} | èŠ‚ç‚¹æ•°: ${nodeCount} | æœ€åä¿å­˜: ${lastSaved}
                        </div><br>`;
                    } catch (e) {
                        html += `<div>
                            <span class="storage-key">${key}</span><br>
                            <span style="color: #ff6666;">æ•°æ®è§£æé”™è¯¯: ${e.message}</span>
                        </div><br>`;
                    }
                });
            }
            
            storageState.innerHTML = html;
        }

        // æ£€æŸ¥å†²çª
        function checkConflicts() {
            const results = document.getElementById('conflictResults');
            let conflicts = [];
            
            // æ£€æŸ¥é‡å¤çš„shareId
            const shareIds = new Map();
            const boardIds = [];
            
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('whiteboard-data-')) {
                    const boardId = key.replace('whiteboard-data-', '');
                    boardIds.push(boardId);
                    
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data.shareId) {
                            if (shareIds.has(data.shareId)) {
                                conflicts.push(`é‡å¤çš„shareId: ${data.shareId} (${shareIds.get(data.shareId)} å’Œ ${boardId})`);
                            } else {
                                shareIds.set(data.shareId, boardId);
                            }
                        }
                    } catch {}
                }
            });
            
            // æ£€æŸ¥persistå­˜å‚¨å†²çª
            const persistKeys = ['whiteboard-storage', 'whiteboard-current-board'];
            persistKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    conflicts.push(`å‘ç°persistå­˜å‚¨: ${key}`);
                }
            });
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å­¤ç«‹çš„æ•°æ®
            const writeOperations = logEntries.filter(e => e.type === 'write' && e.key.startsWith('whiteboard-'));
            const rapidWrites = {};
            
            writeOperations.forEach(op => {
                if (!rapidWrites[op.key]) rapidWrites[op.key] = 0;
                rapidWrites[op.key]++;
            });
            
            Object.entries(rapidWrites).forEach(([key, count]) => {
                if (count > 5) {
                    conflicts.push(`é¢‘ç¹å†™å…¥: ${key} (${count} æ¬¡)`);
                }
            });
            
            if (conflicts.length === 0) {
                results.innerHTML = '<div style="color: #00ff88;">âœ… æœªå‘ç°å†²çª</div>';
            } else {
                results.innerHTML = conflicts.map(c => `<div style="color: #ffaa00;">âš ï¸ ${c}</div>`).join('');
            }
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLogs() {
            const dataStr = JSON.stringify(logEntries, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `whiteboard-storage-logs-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            updateMonitorStatus();
            refreshStorageState();
        });
    </script>
</body>
</html> 