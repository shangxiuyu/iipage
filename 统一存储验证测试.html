<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—ƒï¸ ç»Ÿä¸€å­˜å‚¨éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .test-section h3 {
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            margin-left: auto;
        }
        .status.success { background: #10b981; }
        .status.error { background: #ef4444; }
        .status.warning { background: #f59e0b; }
        .status.info { background: #3b82f6; }
        
        button {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        button:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .data-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #10b981;
        }
        
        .warning-box {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.4);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ƒï¸ ç»Ÿä¸€å­˜å‚¨éªŒè¯æµ‹è¯•</h1>
            <p>éªŒè¯ç™½æ¿åº”ç”¨æ•°æ®æ˜¯å¦æ­£ç¡®ä¿å­˜åˆ°IndexedDBï¼Œå½»åº•æ‘†è„±localStorage</p>
        </div>

        <div class="warning-box">
            <h3>âš ï¸ é‡è¦æç¤º</h3>
            <p>1. è¯·å…ˆæ‰“å¼€ç™½æ¿åº”ç”¨ï¼š<a href="http://localhost:5174" target="_blank" style="color: #60a5fa;">http://localhost:5174</a></p>
            <p>2. åœ¨ç™½æ¿åº”ç”¨ä¸­æ·»åŠ ä¸€äº›å¡ç‰‡</p>
            <p>3. ç‚¹å‡»é¡¹ç›®ä¸­å¿ƒå¹¶ä¿å­˜ç™½æ¿</p>
            <p>4. å›åˆ°æ­¤é¡µé¢éªŒè¯æ•°æ®å­˜å‚¨</p>
        </div>

        <!-- IndexedDB æ£€æŸ¥ -->
        <div class="test-section">
            <h3>
                ğŸ“Š IndexedDB æ•°æ®æ£€æŸ¥
                <div class="status info" id="indexeddb-status">å¾…æ£€æŸ¥</div>
            </h3>
            <button onclick="checkIndexedDBData()">ğŸ” æ£€æŸ¥IndexedDBæ•°æ®</button>
            <button onclick="clearIndexedDBData()">ğŸ—‘ï¸ æ¸…ç©ºIndexedDB</button>
            <div class="data-display" id="indexeddb-data">ç‚¹å‡»æŒ‰é’®æ£€æŸ¥æ•°æ®...</div>
        </div>

        <!-- localStorage æ£€æŸ¥ -->
        <div class="test-section">
            <h3>
                ğŸ’¾ localStorage æ£€æŸ¥
                <div class="status warning" id="localstorage-status">å¾…æ£€æŸ¥</div>
            </h3>
            <button onclick="checkLocalStorageData()">ğŸ” æ£€æŸ¥localStorageæ•°æ®</button>
            <button onclick="clearLocalStorageData()">ğŸ—‘ï¸ æ¸…ç©ºlocalStorage</button>
            <div class="data-display" id="localstorage-data">ç‚¹å‡»æŒ‰é’®æ£€æŸ¥æ•°æ®...</div>
        </div>

        <!-- æ•°æ®è¿ç§»æµ‹è¯• -->
        <div class="test-section">
            <h3>
                ğŸ”„ æ•°æ®è¿ç§»æµ‹è¯•
                <div class="status info" id="migration-status">å¾…æµ‹è¯•</div>
            </h3>
            <button onclick="simulateDataMigration()">ğŸ”„ æ¨¡æ‹Ÿæ•°æ®è¿ç§»</button>
            <button onclick="createTestData()">â• åˆ›å»ºæµ‹è¯•æ•°æ®</button>
            <div class="data-display" id="migration-result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>

        <div class="instructions">
            <h3>ğŸ“‹ æµ‹è¯•æµç¨‹</h3>
            <ol>
                <li>é¦–å…ˆåœ¨ç™½æ¿åº”ç”¨ä¸­åˆ›å»ºä¸€äº›å¡ç‰‡</li>
                <li>ä¿å­˜ç™½æ¿æ•°æ®</li>
                <li>å›åˆ°æ­¤é¡µé¢æ£€æŸ¥IndexedDBä¸­æ˜¯å¦æœ‰æ•°æ®</li>
                <li>ç¡®è®¤localStorageä¸­ä¸å†æœ‰ç™½æ¿æ•°æ®ï¼ˆåªæœ‰ä¸»é¢˜ç­‰è®¾ç½®ï¼‰</li>
                <li>æµ‹è¯•æ•°æ®è¿ç§»åŠŸèƒ½</li>
            </ol>
        </div>
    </div>

    <script>
        // æ‰“å¼€IndexedDBè¿æ¥
        async function openWhiteboardDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('WhiteboardDatabase', 1);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // æ£€æŸ¥IndexedDBæ•°æ®
        async function checkIndexedDBData() {
            const statusEl = document.getElementById('indexeddb-status');
            const dataEl = document.getElementById('indexeddb-data');
            
            try {
                statusEl.textContent = 'æ£€æŸ¥ä¸­...';
                statusEl.className = 'status info';
                
                const db = await openWhiteboardDB();
                const transaction = db.transaction(['boards'], 'readonly');
                const store = transaction.objectStore('boards');
                
                const allBoards = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                
                if (allBoards.length === 0) {
                    statusEl.textContent = 'æ— æ•°æ®';
                    statusEl.className = 'status warning';
                    dataEl.textContent = 'ğŸ“­ IndexedDBä¸­æš‚æ— ç™½æ¿æ•°æ®\n\nè¯·å…ˆåœ¨ç™½æ¿åº”ç”¨ä¸­ï¼š\n1. æ·»åŠ ä¸€äº›å¡ç‰‡\n2. ç‚¹å‡»é¡¹ç›®ä¸­å¿ƒ\n3. ä¿å­˜å½“å‰ç™½æ¿';
                } else {
                    statusEl.textContent = `å‘ç°${allBoards.length}ä¸ªç™½æ¿`;
                    statusEl.className = 'status success';
                    
                    const formattedData = allBoards.map((board, index) => {
                        const nodeCount = board.data && board.data.nodes ? board.data.nodes.length : 0;
                        const connectionCount = board.data && board.data.connections ? board.data.connections.length : 0;
                        
                        return `ğŸ“‹ ç™½æ¿ ${index + 1}: ${board.title}
ğŸ†” ID: ${board.id}
ğŸ’³ å¡ç‰‡æ•°: ${nodeCount}
ğŸ”— è¿çº¿æ•°: ${connectionCount}
ğŸ“… åˆ›å»ºæ—¶é—´: ${new Date(board.createdAt).toLocaleString()}
ğŸ“… æ›´æ–°æ—¶é—´: ${new Date(board.updatedAt).toLocaleString()}
---`;
                    }).join('\n');
                    
                    dataEl.textContent = `âœ… IndexedDBæ•°æ®æ£€æŸ¥æˆåŠŸï¼\n\n${formattedData}\n\nğŸ‰ ç»Ÿä¸€å­˜å‚¨ç³»ç»Ÿå·¥ä½œæ­£å¸¸ï¼`;
                }
                
                db.close();
            } catch (error) {
                statusEl.textContent = 'æ£€æŸ¥å¤±è´¥';
                statusEl.className = 'status error';
                dataEl.textContent = `âŒ æ£€æŸ¥IndexedDBæ—¶å‡ºé”™:\n${error.message}`;
            }
        }

        // æ£€æŸ¥localStorageæ•°æ®
        function checkLocalStorageData() {
            const statusEl = document.getElementById('localstorage-status');
            const dataEl = document.getElementById('localstorage-data');
            
            const whiteboardKeys = [];
            const otherKeys = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('whiteboard-data-') || key.startsWith('whiteboard-storage') || key.startsWith('emergency-whiteboard')) {
                    whiteboardKeys.push(key);
                } else {
                    otherKeys.push(key);
                }
            }
            
            if (whiteboardKeys.length === 0) {
                statusEl.textContent = 'âœ… å·²æ¸…ç†';
                statusEl.className = 'status success';
                dataEl.textContent = `âœ… localStorageä¸­æ²¡æœ‰ç™½æ¿æ•°æ®ï¼Œè¯´æ˜æ•°æ®å·²è¿ç§»åˆ°IndexedDBï¼\n\nå‰©ä½™çš„è®¾ç½®æ•°æ®:\n${otherKeys.map(key => `ğŸ“ ${key}: ${localStorage.getItem(key)?.substring(0, 50)}...`).join('\n')}`;
            } else {
                statusEl.textContent = `âš ï¸ å‘ç°${whiteboardKeys.length}ä¸ªæ—§æ•°æ®`;
                statusEl.className = 'status warning';
                dataEl.textContent = `âš ï¸ localStorageä¸­ä»æœ‰ç™½æ¿æ•°æ®ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ¸…ç†:\n\nç™½æ¿æ•°æ®:\n${whiteboardKeys.map(key => `ğŸ“‹ ${key}`).join('\n')}\n\nè®¾ç½®æ•°æ®:\n${otherKeys.map(key => `ğŸ“ ${key}`).join('\n')}`;
            }
        }

        // æ¸…ç©ºIndexedDBæ•°æ®
        async function clearIndexedDBData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºIndexedDBä¸­çš„æ‰€æœ‰ç™½æ¿æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            try {
                const db = await openWhiteboardDB();
                const transaction = db.transaction(['boards'], 'readwrite');
                const store = transaction.objectStore('boards');
                
                await new Promise((resolve, reject) => {
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                
                db.close();
                alert('âœ… IndexedDBæ•°æ®å·²æ¸…ç©ºï¼');
                checkIndexedDBData();
            } catch (error) {
                alert(`âŒ æ¸…ç©ºå¤±è´¥: ${error.message}`);
            }
        }

        // æ¸…ç©ºlocalStorageä¸­çš„ç™½æ¿æ•°æ®
        function clearLocalStorageData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºlocalStorageä¸­çš„ç™½æ¿æ•°æ®å—ï¼Ÿï¼ˆä¼šä¿ç•™ä¸»é¢˜è®¾ç½®ï¼‰')) {
                return;
            }
            
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('whiteboard-data-') || key.startsWith('whiteboard-storage') || key.startsWith('emergency-whiteboard')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            alert(`âœ… å·²æ¸…é™¤${keysToRemove.length}ä¸ªlocalStorageç™½æ¿æ•°æ®é¡¹ï¼`);
            checkLocalStorageData();
        }

        // æ¨¡æ‹Ÿæ•°æ®è¿ç§»
        async function simulateDataMigration() {
            const statusEl = document.getElementById('migration-status');
            const resultEl = document.getElementById('migration-result');
            
            statusEl.textContent = 'è¿ç§»ä¸­...';
            statusEl.className = 'status info';
            
            try {
                // åˆ›å»ºæµ‹è¯•localStorageæ•°æ®
                const testBoard = {
                    title: 'æµ‹è¯•ç™½æ¿',
                    nodes: [
                        {
                            id: 'test-node-1',
                            x: 100,
                            y: 100,
                            content: [{ type: 'paragraph', children: [{ text: 'æµ‹è¯•å¡ç‰‡ 1' }] }]
                        }
                    ],
                    connections: []
                };
                
                localStorage.setItem('whiteboard-data-test-migration', JSON.stringify(testBoard));
                
                // æ¨¡æ‹Ÿè¿ç§»åˆ°IndexedDB
                const db = await openWhiteboardDB();
                const transaction = db.transaction(['boards'], 'readwrite');
                const store = transaction.objectStore('boards');
                
                const boardMetadata = {
                    id: 'test-migration',
                    title: 'æµ‹è¯•ç™½æ¿',
                    cardCount: testBoard.nodes.length,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    data: testBoard
                };
                
                await new Promise((resolve, reject) => {
                    const request = store.put(boardMetadata);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                
                // æ¸…é™¤localStorageæµ‹è¯•æ•°æ®
                localStorage.removeItem('whiteboard-data-test-migration');
                
                db.close();
                
                statusEl.textContent = 'âœ… è¿ç§»æˆåŠŸ';
                statusEl.className = 'status success';
                resultEl.textContent = `âœ… æ•°æ®è¿ç§»æµ‹è¯•æˆåŠŸï¼\n\næ­¥éª¤:\n1. åœ¨localStorageåˆ›å»ºæµ‹è¯•æ•°æ®\n2. è¿ç§»åˆ°IndexedDB\n3. æ¸…é™¤localStorageåŸæ•°æ®\n4. éªŒè¯è¿ç§»å®Œæˆ\n\nğŸ‰ ç»Ÿä¸€å­˜å‚¨ç³»ç»Ÿæ•°æ®è¿ç§»åŠŸèƒ½æ­£å¸¸ï¼`;
                
            } catch (error) {
                statusEl.textContent = 'âŒ è¿ç§»å¤±è´¥';
                statusEl.className = 'status error';
                resultEl.textContent = `âŒ æ•°æ®è¿ç§»æµ‹è¯•å¤±è´¥:\n${error.message}`;
            }
        }

        // åˆ›å»ºæµ‹è¯•æ•°æ®
        async function createTestData() {
            try {
                const db = await openWhiteboardDB();
                const transaction = db.transaction(['boards'], 'readwrite');
                const store = transaction.objectStore('boards');
                
                const testBoards = [
                    {
                        id: 'test-board-1',
                        title: 'æµ‹è¯•ç™½æ¿ 1',
                        cardCount: 2,
                        createdAt: new Date(),
                        updatedAt: new Date(),
                        data: {
                            nodes: [
                                {
                                    id: 'node-1',
                                    x: 100,
                                    y: 100,
                                    content: [{ type: 'paragraph', children: [{ text: 'è¿™æ˜¯ç¬¬ä¸€å¼ æµ‹è¯•å¡ç‰‡' }] }]
                                },
                                {
                                    id: 'node-2',
                                    x: 300,
                                    y: 200,
                                    content: [{ type: 'paragraph', children: [{ text: 'è¿™æ˜¯ç¬¬äºŒå¼ æµ‹è¯•å¡ç‰‡' }] }]
                                }
                            ],
                            connections: []
                        }
                    },
                    {
                        id: 'test-board-2',
                        title: 'æµ‹è¯•ç™½æ¿ 2',
                        cardCount: 1,
                        createdAt: new Date(),
                        updatedAt: new Date(),
                        data: {
                            nodes: [
                                {
                                    id: 'node-3',
                                    x: 150,
                                    y: 150,
                                    content: [{ type: 'paragraph', children: [{ text: 'ç‹¬ç«‹ç™½æ¿çš„å¡ç‰‡' }] }]
                                }
                            ],
                            connections: []
                        }
                    }
                ];
                
                for (const board of testBoards) {
                    await new Promise((resolve, reject) => {
                        const request = store.put(board);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                }
                
                db.close();
                alert('âœ… æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸï¼');
                checkIndexedDBData();
                
            } catch (error) {
                alert(`âŒ åˆ›å»ºæµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkIndexedDBData();
                checkLocalStorageData();
            }, 500);
        });
    </script>
</body>
</html> 