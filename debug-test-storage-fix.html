<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™½æ¿å­˜å‚¨ä¿®å¤æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            color: #007AFF;
            border-bottom: 2px solid #007AFF;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007AFF;
        }
        .btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 4px;
            font-size: 14px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.danger:hover {
            background: #c82333;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.success:hover {
            background: #1e7e34;
        }
        .storage-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .log {
            background: #1a1a1a;
            color: #00ff88;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 16px 0;
        }
        .status {
            padding: 8px 16px;
            border-radius: 4px;
            margin: 8px 0;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› ï¸ ç™½æ¿å­˜å‚¨ä¿®å¤æµ‹è¯•å·¥å…·</h1>
        
        <div class="section">
            <h2>ğŸ“Š å½“å‰å­˜å‚¨çŠ¶æ€</h2>
            <button class="btn" onclick="scanStorage()">ğŸ” æ‰«æå­˜å‚¨</button>
            <button class="btn danger" onclick="clearPersistStorage()">ğŸ—‘ï¸ æ¸…é™¤persistå­˜å‚¨</button>
            <button class="btn danger" onclick="clearAllWhiteboardData()">âš ï¸ æ¸…é™¤æ‰€æœ‰ç™½æ¿æ•°æ®</button>
            <div id="storageStatus"></div>
        </div>

        <div class="section">
            <h2>ğŸ§ª æµ‹è¯•æ­¥éª¤</h2>
            <ol>
                <li><button class="btn" onclick="step1()">æ­¥éª¤1: æ¸…ç†å†²çªå­˜å‚¨</button></li>
                <li><button class="btn" onclick="step2()">æ­¥éª¤2: åˆ›å»ºæµ‹è¯•ç™½æ¿A</button></li>
                <li><button class="btn" onclick="step3()">æ­¥éª¤3: åˆ›å»ºæµ‹è¯•ç™½æ¿B</button></li>
                <li><button class="btn" onclick="step4()">æ­¥éª¤4: æ¨¡æ‹Ÿæ·»åŠ å¡ç‰‡åˆ°A</button></li>
                <li><button class="btn" onclick="step5()">æ­¥éª¤5: åˆ‡æ¢åˆ°ç™½æ¿B</button></li>
                <li><button class="btn" onclick="step6()">æ­¥éª¤6: æ£€æŸ¥å¡ç‰‡æ˜¯å¦è·‘æ¿</button></li>
            </ol>
            <div id="testStatus"></div>
        </div>

        <div class="section">
            <h2>ğŸ“‹ å®æ—¶æ—¥å¿—</h2>
            <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div class="log" id="logContainer"></div>
        </div>

        <div class="section">
            <h2>ğŸ’¾ å­˜å‚¨è¯¦æƒ…</h2>
            <div id="storageDetails"></div>
        </div>
    </div>

    <script>
        let logContainer = document.getElementById('logContainer');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            logContainer.innerHTML = '';
        }

        function scanStorage() {
            log('ğŸ” å¼€å§‹æ‰«ælocalStorage...');
            const storageKeys = Object.keys(localStorage);
            const whiteboardKeys = storageKeys.filter(key => key.startsWith('whiteboard-'));
            
            log(`å‘ç° ${whiteboardKeys.length} ä¸ªç™½æ¿ç›¸å…³å­˜å‚¨é¡¹:`);
            whiteboardKeys.forEach(key => {
                const data = localStorage.getItem(key);
                const size = new Blob([data]).size;
                log(`  - ${key}: ${size} bytes`);
            });

            updateStorageStatus();
            updateStorageDetails();
        }

        function updateStorageStatus() {
            const statusDiv = document.getElementById('storageStatus');
            const keys = Object.keys(localStorage).filter(key => key.startsWith('whiteboard-'));
            
            let html = '<h3>å­˜å‚¨é¡¹ç›®ç»Ÿè®¡:</h3>';
            
            const persistKeys = keys.filter(key => key.includes('whiteboard-storage') || key.includes('whiteboard-current-board'));
            const boardKeys = keys.filter(key => key.startsWith('whiteboard-data-'));
            
            if (persistKeys.length > 0) {
                html += `<div class="status error">âš ï¸ å‘ç° ${persistKeys.length} ä¸ªpersistå­˜å‚¨é¡¹ (å¯èƒ½å¯¼è‡´å†²çª)</div>`;
                persistKeys.forEach(key => {
                    html += `<div class="storage-item">âŒ ${key}</div>`;
                });
            } else {
                html += `<div class="status success">âœ… æ²¡æœ‰persistå­˜å‚¨å†²çª</div>`;
            }

            html += `<div class="status">${boardKeys.length} ä¸ªç™½æ¿æ•°æ®é¡¹:</div>`;
            boardKeys.forEach(key => {
                const boardId = key.replace('whiteboard-data-', '');
                html += `<div class="storage-item">ğŸ“‹ ç™½æ¿ ${boardId}</div>`;
            });

            statusDiv.innerHTML = html;
        }

        function updateStorageDetails() {
            const detailsDiv = document.getElementById('storageDetails');
            const keys = Object.keys(localStorage).filter(key => key.startsWith('whiteboard-'));
            
            let html = '';
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                let preview = '';
                try {
                    const parsed = JSON.parse(data);
                    if (parsed.nodes) {
                        preview = `åŒ…å« ${parsed.nodes.length} ä¸ªå¡ç‰‡`;
                    } else if (parsed.title) {
                        preview = `æ ‡é¢˜: ${parsed.title}`;
                    } else {
                        preview = 'æœªçŸ¥æ ¼å¼';
                    }
                } catch (e) {
                    preview = 'éJSONæ•°æ®';
                }
                
                html += `
                    <div class="storage-item">
                        <strong>${key}</strong><br>
                        ${preview}<br>
                        <small>å¤§å°: ${new Blob([data]).size} bytes</small>
                        <button class="btn danger" onclick="deleteStorageItem('${key}')">åˆ é™¤</button>
                    </div>
                `;
            });
            
            detailsDiv.innerHTML = html;
        }

        function deleteStorageItem(key) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤å­˜å‚¨é¡¹ "${key}" å—ï¼Ÿ`)) {
                localStorage.removeItem(key);
                log(`ğŸ—‘ï¸ å·²åˆ é™¤å­˜å‚¨é¡¹: ${key}`);
                updateStorageStatus();
                updateStorageDetails();
            }
        }

        function clearPersistStorage() {
            const persistKeys = ['whiteboard-storage', 'whiteboard-current-board'];
            let deleted = 0;
            
            persistKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    deleted++;
                    log(`ğŸ—‘ï¸ å·²åˆ é™¤persistå­˜å‚¨: ${key}`);
                }
            });
            
            if (deleted === 0) {
                log('â„¹ï¸ æ²¡æœ‰å‘ç°persistå­˜å‚¨é¡¹');
            } else {
                log(`âœ… å·²æ¸…é™¤ ${deleted} ä¸ªpersistå­˜å‚¨é¡¹`);
            }
            
            updateStorageStatus();
            updateStorageDetails();
        }

        function clearAllWhiteboardData() {
            if (!confirm('âš ï¸ è¿™å°†åˆ é™¤æ‰€æœ‰ç™½æ¿æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                return;
            }
            
            const keys = Object.keys(localStorage).filter(key => key.startsWith('whiteboard-'));
            keys.forEach(key => {
                localStorage.removeItem(key);
            });
            
            log(`ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰ç™½æ¿æ•°æ® (${keys.length} é¡¹)`);
            updateStorageStatus();
            updateStorageDetails();
        }

        // æµ‹è¯•æ­¥éª¤
        function step1() {
            log('ğŸ§ª æ­¥éª¤1: æ¸…ç†å†²çªå­˜å‚¨');
            clearPersistStorage();
            document.getElementById('testStatus').innerHTML = '<div class="status success">âœ… æ­¥éª¤1å®Œæˆ</div>';
        }

        function step2() {
            log('ğŸ§ª æ­¥éª¤2: åˆ›å»ºæµ‹è¯•ç™½æ¿A');
            const boardA = {
                id: 'test-board-a',
                title: 'æµ‹è¯•ç™½æ¿A',
                nodes: [],
                connections: [],
                createdAt: new Date().toISOString(),
                isActive: true
            };
            
            localStorage.setItem('whiteboard-data-test-board-a', JSON.stringify(boardA));
            log('âœ… å·²åˆ›å»ºæµ‹è¯•ç™½æ¿A');
            updateStorageDetails();
            document.getElementById('testStatus').innerHTML = '<div class="status success">âœ… æ­¥éª¤2å®Œæˆ</div>';
        }

        function step3() {
            log('ğŸ§ª æ­¥éª¤3: åˆ›å»ºæµ‹è¯•ç™½æ¿B');
            const boardB = {
                id: 'test-board-b',
                title: 'æµ‹è¯•ç™½æ¿B',
                nodes: [],
                connections: [],
                createdAt: new Date().toISOString(),
                isActive: false
            };
            
            localStorage.setItem('whiteboard-data-test-board-b', JSON.stringify(boardB));
            log('âœ… å·²åˆ›å»ºæµ‹è¯•ç™½æ¿B');
            updateStorageDetails();
            document.getElementById('testStatus').innerHTML = '<div class="status success">âœ… æ­¥éª¤3å®Œæˆ</div>';
        }

        function step4() {
            log('ğŸ§ª æ­¥éª¤4: æ¨¡æ‹Ÿæ·»åŠ å¡ç‰‡åˆ°ç™½æ¿A');
            const boardAData = JSON.parse(localStorage.getItem('whiteboard-data-test-board-a'));
            
            // æ·»åŠ æµ‹è¯•å¡ç‰‡
            const testCard = {
                id: 'test-card-' + Date.now(),
                x: 100,
                y: 100,
                content: [{ type: 'paragraph', children: [{ text: 'è¿™æ˜¯æµ‹è¯•å¡ç‰‡ï¼Œåº”è¯¥åœ¨ç™½æ¿Aä¸­' }] }],
                title: 'æµ‹è¯•å¡ç‰‡A'
            };
            
            boardAData.nodes.push(testCard);
            localStorage.setItem('whiteboard-data-test-board-a', JSON.stringify(boardAData));
            
            log(`âœ… å·²åœ¨ç™½æ¿Aä¸­æ·»åŠ å¡ç‰‡: ${testCard.id}`);
            updateStorageDetails();
            document.getElementById('testStatus').innerHTML = '<div class="status success">âœ… æ­¥éª¤4å®Œæˆ</div>';
        }

        function step5() {
            log('ğŸ§ª æ­¥éª¤5: æ¨¡æ‹Ÿåˆ‡æ¢åˆ°ç™½æ¿B');
            // æ›´æ–°æ´»è·ƒçŠ¶æ€
            const boardAData = JSON.parse(localStorage.getItem('whiteboard-data-test-board-a'));
            const boardBData = JSON.parse(localStorage.getItem('whiteboard-data-test-board-b'));
            
            boardAData.isActive = false;
            boardBData.isActive = true;
            
            localStorage.setItem('whiteboard-data-test-board-a', JSON.stringify(boardAData));
            localStorage.setItem('whiteboard-data-test-board-b', JSON.stringify(boardBData));
            
            log('âœ… å·²åˆ‡æ¢åˆ°ç™½æ¿B');
            updateStorageDetails();
            document.getElementById('testStatus').innerHTML = '<div class="status success">âœ… æ­¥éª¤5å®Œæˆ</div>';
        }

        function step6() {
            log('ğŸ§ª æ­¥éª¤6: æ£€æŸ¥å¡ç‰‡æ˜¯å¦è·‘æ¿');
            const boardAData = JSON.parse(localStorage.getItem('whiteboard-data-test-board-a'));
            const boardBData = JSON.parse(localStorage.getItem('whiteboard-data-test-board-b'));
            
            const cardInA = boardAData.nodes.filter(node => node.id.startsWith('test-card-'));
            const cardInB = boardBData.nodes.filter(node => node.id.startsWith('test-card-'));
            
            let result = '';
            if (cardInA.length > 0 && cardInB.length === 0) {
                result = '<div class="status success">âœ… æµ‹è¯•é€šè¿‡: å¡ç‰‡æ­£ç¡®ä¿ç•™åœ¨ç™½æ¿Aä¸­</div>';
                log('âœ… æµ‹è¯•é€šè¿‡: å¡ç‰‡æ²¡æœ‰è·‘æ¿');
            } else if (cardInB.length > 0) {
                result = '<div class="status error">âŒ æµ‹è¯•å¤±è´¥: å¡ç‰‡è·‘åˆ°äº†ç™½æ¿Bä¸­</div>';
                log('âŒ æµ‹è¯•å¤±è´¥: å‘ç°å¡ç‰‡è·‘æ¿');
            } else {
                result = '<div class="status error">âŒ æµ‹è¯•å¤±è´¥: å¡ç‰‡ä¸¢å¤±</div>';
                log('âŒ æµ‹è¯•å¤±è´¥: å¡ç‰‡ä¸¢å¤±');
            }
            
            log(`ç™½æ¿Aå¡ç‰‡æ•°é‡: ${cardInA.length}`);
            log(`ç™½æ¿Bå¡ç‰‡æ•°é‡: ${cardInB.length}`);
            
            document.getElementById('testStatus').innerHTML = result;
            updateStorageDetails();
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰«æ
        window.onload = function() {
            log('ğŸš€ ç™½æ¿å­˜å‚¨ä¿®å¤æµ‹è¯•å·¥å…·å·²å¯åŠ¨');
            scanStorage();
        };
    </script>
</body>
</html> 