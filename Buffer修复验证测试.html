<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿é‡Œäº‘OSS Bufferä¿®å¤éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .test-section h3 {
            color: #34495e;
            margin-bottom: 15px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .success {
            background: #27ae60 !important;
        }
        
        .error {
            background: #e74c3c !important;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d5f4e6;
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        
        .status.error {
            background: #fdf2f2;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #1976d2;
        }
        
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .config-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .step-indicator {
            display: inline-block;
            background: #3498db;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .step-indicator.completed {
            background: #27ae60;
        }
        
        .step-indicator.error {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ é˜¿é‡Œäº‘OSS Bufferä¿®å¤éªŒè¯æµ‹è¯•</h1>
        
        <div class="config-section">
            <h4>ğŸ“‹ æµ‹è¯•è¯´æ˜</h4>
            <p>
                <strong>é—®é¢˜ï¼š</strong> ä¹‹å‰çš„ä»£ç å°†å­—ç¬¦ä¸²ç›´æ¥ä¼ é€’ç»™OSSçš„putæ–¹æ³•ï¼Œå¯¼è‡´ "Must provide Buffer/Blob/File for put" é”™è¯¯<br>
                <strong>ä¿®å¤ï¼š</strong> ä½¿ç”¨ Buffer.from(content, 'utf-8') å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºBufferå¯¹è±¡<br>
                <strong>éªŒè¯ï¼š</strong> æµ‹è¯•ä¿å­˜åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ
            </p>
        </div>

        <!-- æµ‹è¯•æ­¥éª¤ -->
        <div class="test-section">
            <h3><span class="step-indicator" id="step1">1</span>åˆå§‹åŒ–é˜¿é‡Œäº‘OSSè¿æ¥</h3>
            <button onclick="initializeOSS()">åˆå§‹åŒ–OSSè¿æ¥</button>
            <div id="init-status"></div>
        </div>

        <div class="test-section">
            <h3><span class="step-indicator" id="step2">2</span>æµ‹è¯•Bufferè½¬æ¢ä¿å­˜</h3>
            <button onclick="testBufferSave()" id="save-btn" disabled>ä¿å­˜æµ‹è¯•ç™½æ¿</button>
            <div id="save-status"></div>
            <div id="save-details"></div>
        </div>

        <div class="test-section">
            <h3><span class="step-indicator" id="step3">3</span>éªŒè¯ä¿å­˜çš„æ•°æ®</h3>
            <button onclick="testLoadSaved()" id="load-btn" disabled>åŠ è½½å¹¶éªŒè¯æ•°æ®</button>
            <div id="load-status"></div>
            <div id="load-details"></div>
        </div>

        <div class="test-section">
            <h3><span class="step-indicator" id="step4">4</span>æ£€æŸ¥æ•°æ®å®Œæ•´æ€§</h3>
            <button onclick="testDataIntegrity()" id="integrity-btn" disabled>éªŒè¯æ•°æ®å®Œæ•´æ€§</button>
            <div id="integrity-status"></div>
            <div id="integrity-details"></div>
        </div>

        <!-- å®æ—¶æ—¥å¿— -->
        <div class="test-section">
            <h3>ğŸ“Š å®æ—¶æµ‹è¯•æ—¥å¿—</h3>
            <pre id="log-output">ç­‰å¾…å¼€å§‹æµ‹è¯•...</pre>
        </div>
    </div>

    <script type="module">
        // å¯¼å…¥å¿…è¦çš„æ¨¡å—
        import { aliCloudStorage } from '/src/services/aliCloudStorageService.ts';

        let testBoardId = 'buffer-test-' + Date.now();
        let originalData = null;
        let loadedData = null;

        // å…¨å±€å‡½æ•°
        window.initializeOSS = initializeOSS;
        window.testBufferSave = testBufferSave;
        window.testLoadSaved = testLoadSaved;
        window.testDataIntegrity = testDataIntegrity;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logOutput = document.getElementById('log-output');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logOutput.textContent += `\n[${timestamp}] ${prefix} ${message}`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function setStepStatus(stepNum, status) {
            const step = document.getElementById(`step${stepNum}`);
            step.className = `step-indicator ${status}`;
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function initializeOSS() {
            log('å¼€å§‹åˆå§‹åŒ–é˜¿é‡Œäº‘OSSè¿æ¥...');
            
            try {
                // ä»ç¯å¢ƒå˜é‡è·å–é…ç½®
                const config = {
                    region: import.meta.env.VITE_ALICLOUD_REGION || 'oss-cn-beijing',
                    accessKeyId: import.meta.env.VITE_ALICLOUD_ACCESS_KEY_ID,
                    accessKeySecret: import.meta.env.VITE_ALICLOUD_ACCESS_KEY_SECRET,
                    bucket: import.meta.env.VITE_ALICLOUD_BUCKET || 'my-whiteboard-images'
                };

                if (!config.accessKeyId || !config.accessKeySecret) {
                    throw new Error('é˜¿é‡Œäº‘è®¿é—®å¯†é’¥æœªé…ç½®ï¼Œè¯·æ£€æŸ¥ .env.local æ–‡ä»¶');
                }

                const success = await aliCloudStorage.initialize(config);
                
                if (success) {
                    log('é˜¿é‡Œäº‘OSSåˆå§‹åŒ–æˆåŠŸï¼', 'success');
                    showStatus('init-status', 'âœ… OSSè¿æ¥æˆåŠŸï¼Œå¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æµ‹è¯•', 'success');
                    setStepStatus(1, 'completed');
                    
                    // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
                    document.getElementById('save-btn').disabled = false;
                } else {
                    throw new Error('OSSåˆå§‹åŒ–å¤±è´¥');
                }
                
            } catch (error) {
                log(`OSSåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                showStatus('init-status', `âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                setStepStatus(1, 'error');
            }
        }

        async function testBufferSave() {
            log('å¼€å§‹æµ‹è¯•Bufferè½¬æ¢ä¿å­˜åŠŸèƒ½...');
            
            try {
                // åˆ›å»ºæµ‹è¯•æ•°æ®
                originalData = {
                    id: testBoardId,
                    name: 'Bufferä¿®å¤æµ‹è¯•ç™½æ¿',
                    nodes: [
                        {
                            id: 'node1',
                            x: 100,
                            y: 100,
                            width: 200,
                            height: 150,
                            content: {
                                frontContent: [{
                                    type: 'paragraph',
                                    children: [{ text: 'è¿™æ˜¯æµ‹è¯•å¡ç‰‡å†…å®¹ï¼ŒåŒ…å«ä¸­æ–‡å­—ç¬¦' }]
                                }]
                            },
                            style: { backgroundColor: '#ffffff' },
                            created: new Date().toISOString()
                        }
                    ],
                    connections: [],
                    settings: {
                        background: '#f0f0f0',
                        zoom: 1.0,
                        panX: 0,
                        panY: 0
                    },
                    metadata: {
                        created: new Date().toISOString(),
                        updated: new Date().toISOString(),
                        version: '1.0.0',
                        testId: 'buffer-fix-test'
                    }
                };

                log(`å‡†å¤‡ä¿å­˜ç™½æ¿æ•°æ®ï¼Œæµ‹è¯•ID: ${testBoardId}`);
                log(`æ•°æ®å¤§å°: ${JSON.stringify(originalData).length} å­—ç¬¦`);

                // è°ƒç”¨ä¿å­˜æ–¹æ³•ï¼ˆåº”è¯¥ä½¿ç”¨Bufferï¼‰
                const result = await aliCloudStorage.saveBoard(testBoardId, originalData);
                
                if (result.success) {
                    log('ğŸ‰ Bufferè½¬æ¢ä¿å­˜æˆåŠŸï¼', 'success');
                    showStatus('save-status', 'âœ… ä¿å­˜æˆåŠŸï¼ŒBufferè½¬æ¢æ­£å¸¸å·¥ä½œ', 'success');
                    
                    if (result.url) {
                        showStatus('save-details', `ğŸ“ æ–‡ä»¶URL: ${result.url}`, 'info');
                    }
                    
                    setStepStatus(2, 'completed');
                    document.getElementById('load-btn').disabled = false;
                } else {
                    throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
                }
                
            } catch (error) {
                log(`Bufferä¿å­˜æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                showStatus('save-status', `âŒ ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                setStepStatus(2, 'error');
            }
        }

        async function testLoadSaved() {
            log('å¼€å§‹æµ‹è¯•åŠ è½½å·²ä¿å­˜çš„æ•°æ®...');
            
            try {
                const result = await aliCloudStorage.loadBoard(testBoardId);
                
                if (result.success) {
                    loadedData = result.data;
                    log('âœ… æ•°æ®åŠ è½½æˆåŠŸï¼', 'success');
                    showStatus('load-status', 'âœ… æ•°æ®åŠ è½½æˆåŠŸï¼Œå¯ä»¥è¿›è¡Œå®Œæ•´æ€§éªŒè¯', 'success');
                    
                    const loadDetails = `
                        <strong>åŠ è½½çš„æ•°æ®ä¿¡æ¯ï¼š</strong><br>
                        â€¢ ç™½æ¿ID: ${loadedData.id}<br>
                        â€¢ ç™½æ¿åç§°: ${loadedData.name}<br>
                        â€¢ å¡ç‰‡æ•°é‡: ${loadedData.nodes?.length || 0}<br>
                        â€¢ è¿æ¥æ•°é‡: ${loadedData.connections?.length || 0}<br>
                        â€¢ å…ƒæ•°æ®ç‰ˆæœ¬: ${loadedData.metadata?.version}
                    `;
                    showStatus('load-details', loadDetails, 'info');
                    
                    setStepStatus(3, 'completed');
                    document.getElementById('integrity-btn').disabled = false;
                } else {
                    throw new Error(result.error || 'åŠ è½½å¤±è´¥');
                }
                
            } catch (error) {
                log(`æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                showStatus('load-status', `âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                setStepStatus(3, 'error');
            }
        }

        async function testDataIntegrity() {
            log('å¼€å§‹éªŒè¯æ•°æ®å®Œæ•´æ€§...');
            
            try {
                if (!originalData || !loadedData) {
                    throw new Error('ç¼ºå°‘åŸå§‹æ•°æ®æˆ–åŠ è½½æ•°æ®');
                }

                // æ¯”è¾ƒå…³é”®å­—æ®µ
                const checks = [
                    { field: 'id', original: originalData.id, loaded: loadedData.id },
                    { field: 'name', original: originalData.name, loaded: loadedData.name },
                    { field: 'nodes.length', original: originalData.nodes.length, loaded: loadedData.nodes.length },
                    { field: 'metadata.testId', original: originalData.metadata.testId, loaded: loadedData.metadata.testId },
                ];

                let allPassed = true;
                let checkResults = '<strong>å®Œæ•´æ€§æ£€æŸ¥ç»“æœï¼š</strong><br>';

                for (const check of checks) {
                    const passed = check.original === check.loaded;
                    allPassed = allPassed && passed;
                    
                    checkResults += `â€¢ ${check.field}: ${passed ? 'âœ…' : 'âŒ'} (${check.original} ${passed ? '==' : '!='} ${check.loaded})<br>`;
                    log(`${check.field}: ${passed ? 'PASS' : 'FAIL'} (${check.original} vs ${check.loaded})`);
                }

                // æ£€æŸ¥å¡ç‰‡å†…å®¹
                if (originalData.nodes[0] && loadedData.nodes[0]) {
                    const originalContent = JSON.stringify(originalData.nodes[0].content);
                    const loadedContent = JSON.stringify(loadedData.nodes[0].content);
                    const contentMatch = originalContent === loadedContent;
                    
                    checkResults += `â€¢ å¡ç‰‡å†…å®¹: ${contentMatch ? 'âœ…' : 'âŒ'}<br>`;
                    allPassed = allPassed && contentMatch;
                    log(`å¡ç‰‡å†…å®¹: ${contentMatch ? 'PASS' : 'FAIL'}`);
                }

                if (allPassed) {
                    log('ğŸ‰ æ‰€æœ‰å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡ï¼Bufferä¿®å¤æˆåŠŸï¼', 'success');
                    showStatus('integrity-status', 'âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡ï¼ŒBufferä¿®å¤å®Œå…¨æˆåŠŸï¼', 'success');
                    setStepStatus(4, 'completed');
                } else {
                    log('âš ï¸ éƒ¨åˆ†å®Œæ•´æ€§æ£€æŸ¥æœªé€šè¿‡', 'error');
                    showStatus('integrity-status', 'âš ï¸ æ•°æ®å®Œæ•´æ€§å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥', 'error');
                    setStepStatus(4, 'error');
                }

                showStatus('integrity-details', checkResults, 'info');
                
            } catch (error) {
                log(`å®Œæ•´æ€§éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                showStatus('integrity-status', `âŒ éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                setStepStatus(4, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('Bufferä¿®å¤éªŒè¯æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('ç‚¹å‡» "åˆå§‹åŒ–OSSè¿æ¥" å¼€å§‹æµ‹è¯•...');
        });
    </script>
</body>
</html> 